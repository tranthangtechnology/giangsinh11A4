<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gi√°ng Sinh 11A4 - Special Show</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Roboto', sans-serif; }
        #canvas-container { width: 100%; height: 100vh; display: block; }
        
        .title {
            position: absolute; top: 15px; width: 100%; text-align: center;
            font-family: 'Great Vibes', cursive; 
            font-size: clamp(2rem, 5vw, 4rem);
            color: #fff;
            text-shadow: 0 0 20px #ff0055, 0 0 40px #ff0055; 
            z-index: 100; pointer-events: none;
            padding: 0 10px; box-sizing: border-box;
        }

        .button-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; z-index: 100;
            flex-wrap: wrap; justify-content: center; width: 98%; max-width: 800px;
        }

        .action-btn {
            padding: 8px 12px; 
            font-size: clamp(0.7rem, 2.5vw, 1rem);
            color: white; border: none; border-radius: 50px; cursor: pointer;
            font-family: 'Roboto', sans-serif; font-weight: bold;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); transition: all 0.3s ease;
            text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;
            flex: 1 1 auto; 
            max-width: 150px;
        }
        .action-btn:hover { transform: scale(1.05); }

        #open-all-btn { background: linear-gradient(45deg, #ff0055, #c0392b); box-shadow: 0 0 20px rgba(255, 0, 85, 0.6); }
        #slideshow-btn { background: linear-gradient(45deg, #00b09b, #96c93d); box-shadow: 0 0 20px rgba(0, 176, 155, 0.6); }
        #shuffle-btn { background: linear-gradient(45deg, #8e44ad, #9b59b6); box-shadow: 0 0 20px rgba(142, 68, 173, 0.6); }
        #music-btn { background: linear-gradient(45deg, #f1c40f, #f39c12); box-shadow: 0 0 20px rgba(241, 196, 15, 0.6); color: #333; }

        #welcome-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3000; 
            display: flex; justify-content: center; align-items: center;
            padding: 10px; box-sizing: border-box; 
        }

        .welcome-content {
            text-align: center; 
            border: 2px solid #ffd700; 
            padding: 15px 15px; 
            border-radius: 15px; 
            
            background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.4)), url('a4.jpg');
            
            background-size: cover; background-position: center; background-repeat: no-repeat;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.6); 
            
            width: 100%; max-width: 600px; 
            max-height: 95vh; 
            
            display: flex; flex-direction: column; align-items: center;
            animation: fadeIn 1s ease-out; 
            position: relative;
        }

        .wc-title { 
            font-family: 'Great Vibes'; 
            font-size: clamp(2.5rem, 8vw, 3.5rem); 
            margin: 0; padding: 0;
            color: #ff0055; text-shadow: 0 0 10px #fff; line-height: 1.1; 
        }
        .wc-class { 
            color: #fff; 
            font-size: clamp(1.2rem, 5vw, 1.8rem); 
            margin: 2px 0 5px 0;
            font-weight: bold; 
            text-shadow: 1px 1px 4px rgba(0,0,0,0.8); 
        }
        .wc-subtitle { 
            font-size: clamp(0.85rem, 3vw, 1.1rem); 
            margin: 5px 0 10px 0; 
            font-weight: bold; color: #ffd700; text-shadow: 1px 1px 5px #000; 
        }
        
        .welcome-desc {
            font-size: 0.9rem; line-height: 1.4; color: #eee; 
            margin: 5px 0; text-align: justify;
            background: rgba(0, 0, 0, 0.6); 
            padding: 10px; 
            border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
            width: 100%; box-sizing: border-box;
            max-height: 45vh; 
            overflow-y: auto; 
        }

        .welcome-desc p { margin: 6px 0; }

        .admin-email { color: #4fc3f7; font-weight: bold; text-decoration: none; word-break: break-all; } 
        
        #start-btn {
            margin-top: 10px; margin-bottom: 5px;
            padding: 10px 30px; 
            font-size: clamp(1rem, 4vw, 1.3rem);
            background: linear-gradient(45deg, #c0392b, #d35400); color: white; border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 15px #ff0000; font-weight: bold; font-family: 'Roboto', sans-serif; 
            animation: pulse 1.5s infinite; white-space: nowrap;
            flex-shrink: 0;
        }
        
        .note-headphone { color: #ffd700; font-style: italic; margin-top: 5px; font-size: 0.8rem; text-shadow: 1px 1px 5px #000; }

        @media (max-height: 600px) {
            .wc-title { font-size: 2rem; }
            .welcome-desc { max-height: 35vh; font-size: 0.85rem; }
            #start-btn { padding: 8px 20px; font-size: 1rem; }
            .welcome-content { padding: 10px; }
        }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(8px);
            padding: 10px; box-sizing: border-box;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 15px; text-align: center;
            border: 3px solid #c0392b; box-shadow: 0 0 30px rgba(255,0,85,0.5);
            transform: scale(0.8); opacity: 0; transition: all 0.3s ease-out;
            width: 100%; max-width: 500px; 
            max-height: 90vh; 
            display: flex; flex-direction: column; position: relative;
        }
        .modal.active .modal-content { transform: scale(1); opacity: 1; }
        .close-btn { position: absolute; top: 5px; right: 10px; font-size: 24px; cursor: pointer; color: #555; padding: 5px; z-index: 10; }
        
        h2 { margin: 5px 0; color: #c0392b; font-family: 'Roboto', sans-serif; font-weight: 700; font-size: clamp(1.2rem, 4vw, 1.6rem); text-transform: uppercase; line-height: 1.2; }
        .stt-label { font-size: 0.9rem; color: #666; margin-bottom: 5px; display: block; font-style: italic; }
        #wish-content-area { 
            overflow-y: auto; flex-grow: 1; padding: 0 5px; margin-bottom: 5px; text-align: center;
            max-height: 60vh; 
        }
        
        .list-item { text-align: left; border-bottom: 1px dashed #ccc; padding: 8px 0; }
        .list-name { font-weight: bold; color: #c0392b; font-size: 0.95rem; }
        .list-wish { font-style: italic; color: #333; margin-top: 2px; font-size: 0.9rem; }
        .single-wish { 
            font-size: clamp(1.1rem, 4vw, 1.4rem); 
            line-height: 1.4; color: #333; font-family: 'Great Vibes', cursive; margin-top: 10px; 
            word-wrap: break-word;
        }
        
        .instruction { 
            position: absolute; bottom: 70px; width: 100%; text-align: center; 
            color: rgba(255,255,255,0.6); font-size: 0.75rem; pointer-events: none; padding: 0 10px;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #c0392b; border-radius: 4px; }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.159.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.159.0/examples/jsm/" } }
    </script>
</head>
<body>
    <audio id="bg-music" loop><source src="noel.mp3" type="audio/mpeg"></audio>

    <div id="welcome-modal">
        <div class="welcome-content">
            <h1 class="wc-title">Merry Christmas</h1>
            <h2 class="wc-class">L·ªõp 11A4</h2>
            <p class="wc-subtitle">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi kh√¥ng gian Gi√°ng Sinh 11A4!</p>
            
            <div class="welcome-desc">
                <p><strong>Dear 11A4,</strong></p>
                <p>üéÅ "C·∫£m ∆°n c√°c b·∫°n ƒë√£ ·ªü l·∫°i ƒë·∫øn gi√¢y ph√∫t n√†y. M√¨nh c√≥ m·ªôt m√≥n qu√† tinh th·∫ßn nh·ªè l√† s·∫£n ph·∫©m m√¨nh t·ª± ph√°t tri·ªÉn, mu·ªën g·ª≠i t·∫∑ng m·ªçi ng∆∞·ªùi l√†m k·ª∑ ni·ªám.Hy v·ªçng m√≥n qu√† c√¥ng ngh·ªá n√†y s·∫Ω mang l·∫°i cho c√°c b·∫°n nh·ªØng tr·∫£i nghi·ªám th√∫ v·ªã trong ƒë√™m nay. Ch√∫c t·∫•t c·∫£ m·ªçi ng∆∞·ªùi Gi√°ng sinh an l√†nh v√† nƒÉm m·ªõi r·ª±c r·ª°!"</p>
                <p>üìß Email admin: <span class="admin-email">tranthangg1409@gmail.com</span></p>
                <p style="margin-top: 5px; font-size: 0.85rem;"><em>Kh·∫£ nƒÉng m√¨nh ch·ªâ t·ªõi ƒë√¢y, c√≥ g√¨ sai s√≥t mong m·ªçi ng∆∞·ªùi b·ªè qua. Xin c·∫£m ∆°n!</em></p>
                <p style="text-align: center; font-weight: bold; margin-top: 10px; color: #ff6b6b; font-size: 1rem;">‚ù§Ô∏è Ch√∫c c√°c b·∫°n m·ªôt m√πa Gi√°ng Sinh an l√†nh ‚ù§Ô∏è</p>
                <p style="text-align: center; font-weight: bold; margin-top: 10px; color: #ff6b6b; font-size: 1rem;">‚ù§Ô∏è happy christmas 11A4 ‚ù§Ô∏è</p>
            </div>
            
            <p class="note-headphone">üéß ƒêeo tai nghe ƒë·ªÉ c√≥ tr·∫£i nghi·ªám t·ªët nh·∫•t</p>
            <button id="start-btn">üéÑ NH·∫§N ƒê·ªÇ V√ÄO TI·ªÜC üéÑ</button>
        </div>
    </div>

    <div class="title">Merry Christmas 11A4</div>
    <div id="canvas-container"></div>
    
    <div class="instruction">Xoay chu·ªôt ƒë·ªÉ ng·∫Øm nh√¨n - Nh·∫•p v√†o h·ªôp qu√† ƒë·ªÉ m·ªü!</div>

    <div class="button-container">
        <button id="slideshow-btn" class="action-btn">‚ñ∂ T·ª± ƒê·ªông</button>
        <button id="shuffle-btn" class="action-btn">üîÄ Tr√°o ƒê·ªïi</button>
        <button id="open-all-btn" class="action-btn">üéÅ Xem List</button>
        <button id="music-btn" class="action-btn">üîä B·∫≠t Nh·∫°c</button>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="wisher-name"></h2>
            <span id="stt-display" class="stt-label"></span>
            <div id="wish-content-area"></div>
            <div style="font-size: 24px; margin-top: 5px;">üéÖüéÅü¶å</div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { gsap } from 'https://cdn.skypack.dev/gsap';

        const bgMusic = document.getElementById('bg-music');
        const musicBtn = document.getElementById('music-btn');
        const welcomeModal = document.getElementById('welcome-modal');
        const startBtn = document.getElementById('start-btn');
        let isMusicPlaying = false;

        function updateMusicButton() { musicBtn.innerText = isMusicPlaying ? "üîä T·∫Øt" : "üîá B·∫≠t"; }
        startBtn.addEventListener('click', () => {
            welcomeModal.style.opacity = '0';
            setTimeout(() => { welcomeModal.style.display = 'none'; }, 500);
            bgMusic.play().then(() => { isMusicPlaying = true; updateMusicButton(); }).catch(e => console.log("L·ªói nh·∫°c:", e));
        });
        musicBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (bgMusic.paused) { bgMusic.play(); isMusicPlaying = true; } else { bgMusic.pause(); isMusicPlaying = false; }
            updateMusicButton();
        })
        const classList = [
            "Nguy·ªÖn Ho√†ng Thi√™n BƒÉnggg", "Nguy·ªÖn Th·ªã B·∫£o Cang", "L√™ VƒÉn ƒê√¥ng", "Nguy·ªÖn Th·ªã M·ªπ H·∫°nh",
            "L√™ Ho√†ng Ph∆∞∆°ng H√¢n", "ƒêinh L√™ Th·∫ø Hi·ªÉn", "L√™ Th·ªã Thanh Hoa", "H·ªì T·ªëng Huy Ho√†ng",
            "B√πi L√™ Huy", "Nguy·ªÖn Cao Khang", "L√™ VƒÉn Khu√™", "Ksor H' Mai Lan",
            "Nguy·ªÖn Th·ªã C·∫©m Linh", "Nguy·ªÖn Tr·ªçng Nh∆∞ Ng·ªçc", "L√™ Trung Nguy√™n", "Ho√†ng Th·ªã Y·∫øn Nhi",
            "Phan Ho√†ng Nhi", "ƒê·∫∑ng Th√πy Nhi√™n", "D∆∞∆°ng Thi B√≠ch Nh∆∞", "ƒê·∫∑ng Qu·ª≥nh Nh∆∞",
            "Nguy·ªÖn Th·ªã Qu·ª≥nh Nh∆∞", "Ho√†ng Thanh Ph∆∞∆°ng", "Nguy·ªÖn Th·ªã Thanh Ph∆∞∆°ng", "ƒê·∫∑ng Th·ªã H·∫£i Quy√™n",
            "T√¥ N·ªØ Nh∆∞ Qu·ª≥nh", "Nguy·ªÖn Qu·ªëc T√†i qu·∫ßn x√¨", "L√™ Tr·ªçng T√¢n", "Ng√¥ Ph∆∞∆°ng Th·∫£o",
            "Tr·∫ßn Th·∫Øng Technology", "Nguy·ªÖn T√¢m Th·∫≠t", "Vi Th·ªã Th√°i Th√πy", "Nguy·ªÖn Anh Th∆∞",
            "Tr·∫ßn Tuy·∫øt Thy", "Nguy·ªÖn C√¥ng Tr√¨nh", "ƒêo√†n Th·ªã Thanh Tr√∫c", "Tr·∫ßn ƒê·ª©c Trung",
            "Nguy·ªÖn Tr∆∞·ªùng Tu√¢n", "D∆∞∆°ng H√† T√∫ Uy√™n", "Nguy·ªÖn Th·ªã M·ªπ Uy√™n", "Nguy·ªÖn Quang Vinh"
        ];
        const specificWishes = [
            "Ch√∫c B·∫°n Thi√™n BƒÉnggg gi√°ng sinh an l√†nh v√† ·∫•m √°p, ch√∫c b·∫°n m√£i t·ªèa s√°ng !", 
            "Ch√∫c B·∫£o Cang lu√¥n xinh ƒë·∫πp, r·∫°ng r·ª° v√† h·ªçc t·∫≠p ng√†y c√†ng ti·∫øn b·ªô nh√©!", 
            "Ch√∫c VƒÉn ƒê√¥ng m·ªôt m√πa Noel th·∫≠t vui, s·ªõm t√¨m ƒë∆∞·ª£c 'g·∫•u' ƒë·ªÉ ƒëi ch∆°i nha,b·ªõt loi nhoi l√† ok!", 
            "Ch√∫c M·ªπ H·∫°nh lu√¥n h·ªçc gi·ªèi, ƒë·∫°t ƒëi·ªÉm cao trong k·ª≥ thi s·∫Øp t·ªõi!", 
            "Ch√∫c Ph∆∞∆°ng H√¢n gi√°ng sinh ·∫•m √°p, nh·∫≠n ƒë∆∞·ª£c th·∫≠t nhi·ªÅu qu√† to!", 
            "Ch√∫c Th·∫ø Hi·ªÉn leo rank th·∫ßn t·ªëc, ch∆°i game hay m√† h·ªçc v·∫´n gi·ªèi!", 
            "Ch√∫c Thanh Hoa lu√¥n duy√™n d√°ng, ƒë√°ng y√™u v√† g·∫∑p nhi·ªÅu may m·∫Øn.", 
            "Ch√∫c Huy Ho√†ng lu√¥n ƒë·∫πp trai, phong ƒë·ªô v√† th√†nh c√¥ng trong m·ªçi vi·ªác.", 
            "Wishing Huylee a holiday season filled with laughter and joy!.", 
            "Ch√∫c Cao Khang b√°nh bao ti·ªÅn ƒë·∫ßy t√∫i, t√¨nh ƒë·∫ßy tim, Gi√°ng sinh vui v·∫ª,!", 
            "Ch√∫c VƒÉn Khu√™ lu√¥n m·∫°nh kh·ªèe, m√∫a lau hay nh√©.", 
            "Ch√∫c Mai Lan c√≥ 1 m√πa noel ·∫•m √°p gi·ªØ v·ªØng th√†nh t√≠ch, tr·ªü th√†nh b√°c s·ªπ gi·ªèi.", 
            "Ch√∫c C·∫©m Linh m√πa ƒë√¥ng kh√¥ng l·∫°nh, lu√¥n c√≥ ng∆∞·ªùi th∆∞∆°ng b√™n c·∫°nh.", 
            "Ch√∫c Nh∆∞ Ng·ªçc h·ªçc k·ª≥ n√†y 10 ph·∫©y t·∫•t c·∫£ c√°c m√¥n nha!", 
            "Ch√∫c Trung Nguy√™n v·∫°n s·ª± nh∆∞ √Ω, t·ª∑ s·ª± nh∆∞ m∆°, Gi√°ng sinh an l√†nh.", 
            "Ch√∫c Y·∫øn Nhi lu√¥n vui v·∫ª, l·∫°c quan v√† y√™u ƒë·ªùi nh∆∞ b√¢y gi·ªù.", 
            "Ch√∫c Phan Ho√†ng Nhi ng√†y c√†ng xinh ƒë·∫πp v√† th√†nh c√¥ng r·ª±c r·ª°.", 
            "Ch√∫c Th√πy Nhi√™n ƒÉn nhi·ªÅu kh√¥ng b√©o, lu√¥n gi·ªØ d√°ng chu·∫©n nha!", 
            "Ch√∫c B√≠ch Nh∆∞ Gi√°ng sinh h·∫°nh ph√∫c b√™n gia ƒë√¨nh v√† b·∫°n b√®.", 
            "Ch√∫c ƒê·∫∑ng Qu·ª≥nh Nh∆∞ nƒÉm m·ªõi b·ª©t ph√°, ƒë·∫°t ƒë∆∞·ª£c m·ªçi m·ª•c ti√™u.", 
            "Ch√∫c Nguy·ªÖn Th·ªã Qu·ª≥nh Nh∆∞ lu√¥n l√† c√¥ g√°i ng·ªçt ng√†o v√† ƒë√°ng y√™u nh·∫•t.", 
            "Ch√∫c H Thanh Ph∆∞∆°ng lu√¥n t·ª± tin, t·ªèa s√°ng v√† g·∫∑p nhi·ªÅu ƒëi·ªÅu t·ªët l√†nh.", 
            "Ch√∫c Nguy·ªÖn Th·ªã Thanh Ph∆∞∆°ng m·ªôt m√πa Noel ·∫•m √°p y√™u th∆∞∆°ng.", 
            "Ch√∫c H·∫£i Quy√™n lu√¥n r·∫°ng r·ª° n·ª• c∆∞·ªùi tr√™n m√¥i m·ªói ng√†y.", 
            "Ch√∫c Nh∆∞ Qu·ª≥nh h·ªçc gi·ªèi, chƒÉm ngoan v√† ƒë∆∞·ª£c m·ªçi ng∆∞·ªùi y√™u m·∫øn.", 
            "Ch√∫c qu·∫ßn x√¨ h·ªçc gi·ªèi to√°n, ƒë·∫°t th√†nh t√≠ch cao sau n√†y c√≤n ch·ªâ tao gi·∫£i t√≠ch.", 
            "Ch√∫c Tr·ªçng T√¢n c√≥ m·ªôt Gi√°ng sinh ƒë√°ng nh·ªõ v·ªõi th·∫≠t nhi·ªÅu k·ª∑ ni·ªám ƒë·∫πp.", 
            "Ch√∫c Ph∆∞∆°ng Th·∫£o xinh x·∫Øn nh∆∞ c√¥ng ch√∫a trong ƒë√™m Gi√°ng sinh.", 
            "NO VALUE!", 
            "Ch√∫c T√¢m Th·∫≠t lu√¥n ch√¢n th√†nh, vui v·∫ª v√† ƒë∆∞·ª£c m·ªçi ng∆∞·ªùi qu√Ω m·∫øn.", 
            "Ch√∫c Th√°i Th√πy m·ªôt m√πa l·ªÖ h·ªôi lung linh s·∫Øc m√†u v√† ng·∫≠p tr√†n h·∫°nh ph√∫c.", 
            "Ch√∫c Anh Th∆∞ h·ªçc t·∫≠p t·∫•n t·ªõi, t∆∞∆°ng lai r·ªông m·ªü th√™nh thang.", 
            "Ch√∫c Tuy·∫øt Thy lu√¥n d·ªãu d√†ng, d·ªÖ th∆∞∆°ng v√† may m·∫Øn ng·∫≠p tr√†n.", 
            "Ch√∫c c√° tr√¨nh m·∫°nh m·∫Ω, ga lƒÉng v√† ƒë·∫°t nhi·ªÅu th√†nh t√≠ch t·ªët, ch√∫c b·∫°n tr·ªü th√†nh b√°c s·ªπ ƒë·∫°i t√†i nh√©.", 
            "Ch√∫c Thanh Tr√∫c lu√¥n t∆∞∆°i vui nh∆∞ hoa n·ªü m√πa xu√¢n.", 
            "Ch√∫c ƒê·ª©c Trung th√¥ng minh, lanh l·ª£i v√† lu√¥n d·∫´n ƒë·∫ßu trong l·ªõp.", 
            "Ch√∫c Tr∆∞·ªùng Tu√¢n ido c√≥ ng√†y l·ªÖ vui, ƒë·∫°t ƒë∆∞·ª£c th√†nh t√≠ch mong mu·ªën nh√©.", 
            "Ch√∫c T√∫ Uy√™n lu√¥n xinh ƒë·∫πp, gi·ªèi giang nh√©!", 
            "Ch√∫c M·ªπ Uy√™n m·ªôt m√πa Gi√°ng sinh an l√†nh, v·∫°n s·ª± b√¨nh an.", 
            "Ch√∫c Quang Vinh nƒÉm m·ªõi r·ª±c r·ª°, th√†nh c√¥ng n·ªëi ti·∫øp th√†nh c√¥ng!" 
        ];

        let isShuffled = false; 
        let giftMapping = Array.from({ length: 41 }, (_, i) => i); 

        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.02);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 15);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2 - 0.1; controls.minDistance = 5; controls.maxDistance = 30;

        const ambientLight = new THREE.AmbientLight(0x404040, 2); scene.add(ambientLight);
        const mainLight = new THREE.PointLight(0xffd700, 3, 50); mainLight.position.set(0, 10, 0); mainLight.castShadow = true; scene.add(mainLight);
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.8 }));
        ground.rotation.x = -Math.PI / 2; ground.position.y = -0.1; ground.receiveShadow = true; scene.add(ground);

        const treeGroup = new THREE.Group();
        const treeMat = new THREE.MeshStandardMaterial({ color: 0x0f5e2f, flatShading: true });
        [ [3.5,3,1.5], [2.8,2.5,3.5], [2.0,2,5.2], [1.2,1.5,6.7] ].forEach(p => {
            const m = new THREE.Mesh(new THREE.ConeGeometry(p[0],p[1],16), treeMat);
            m.position.y = p[2]; m.castShadow = true; m.receiveShadow = true; treeGroup.add(m);
        });
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,2,12), new THREE.MeshStandardMaterial({color: 0x4e342e}));
        trunk.position.y=1; trunk.castShadow=true; treeGroup.add(trunk);
        const star = new THREE.Mesh(new THREE.IcosahedronGeometry(0.6,0), new THREE.MeshBasicMaterial({color:0xffff00}));
        star.position.y=7.8; treeGroup.add(star);
        const starLight = new THREE.PointLight(0xffff00, 2, 10); starLight.position.copy(star.position); treeGroup.add(starLight);
        scene.add(treeGroup);

        const lightsGroup = new THREE.Group();
        const lCols = [0xff0000, 0xffff00, 0x0000ff, 0xff00ff];
        for (let i=0; i<100; i++) {
            const c = lCols[Math.floor(Math.random()*lCols.length)];
            const m = new THREE.Mesh(new THREE.SphereGeometry(0.08,8,8), new THREE.MeshBasicMaterial({color:c}));
            const th = Math.random()*Math.PI*2, y = Math.random()*5+2, r = (1-(y-2)/5.5)*3.2+0.1;
            m.position.set(r*Math.cos(th), y, r*Math.sin(th));
            const l = new THREE.PointLight(c, 0.5, 2); l.position.copy(m.position);
            lightsGroup.add(l); lightsGroup.add(m);
            m.userData = {baseColor: new THREE.Color(c), phase: Math.random()*Math.PI*2, speed: 0.5+Math.random()};
        }
        treeGroup.add(lightsGroup);

        function createGiftTexture(text, colorHex) {
            const canvas = document.createElement('canvas'); canvas.width = 256; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#' + colorHex.toString(16).padStart(6, '0'); ctx.fillRect(0, 0, 256, 256);
            ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 20; ctx.strokeRect(0, 0, 256, 256);
            ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.font = 'bold 120px Arial';
            ctx.fillText(text, 128, 128);
            return new THREE.CanvasTexture(canvas);
        }

        const giftsGroup = new THREE.Group();
        const giftMeshes = [];
        const totalGifts = 41;
        for (let i=0; i<totalGifts; i++) {
            const size = 0.7; 
            const cols = [0xd32f2f, 0x1976d2, 0x388e3c, 0x8e24aa, 0xf57c00];
            
            let c = cols[Math.floor(Math.random()*cols.length)];
            let lbl = i < 40 ? i + 1 : "0"; 
            
            if (i>=40) c = 0x333333;
            const g = new THREE.Mesh(new THREE.BoxGeometry(size,size,size), new THREE.MeshStandardMaterial({map:createGiftTexture(lbl,c), roughness:0.3}));
            
            const baseRad = (i % 2 === 0) ? 5 : 7.5;
            const rad = baseRad + Math.random() * 1.5; 
            
            const ang = (i/totalGifts)*Math.PI*2;
            g.position.set(Math.cos(ang)*rad, size/2, Math.sin(ang)*rad);
            g.rotation.y = Math.random()*Math.PI; g.castShadow=true; g.receiveShadow=true;
            g.userData = {id:i, label:lbl, isGift:true};
            giftsGroup.add(g); giftMeshes.push(g);
        }
        scene.add(giftsGroup);

        const snowGeo = new THREE.BufferGeometry();
        const snowCount = 2000; const snowPos = new Float32Array(snowCount*3); const snowVel = [];
        for (let i=0; i<snowCount; i++) {
            snowPos[i*3] = (Math.random()-0.5)*50; snowPos[i*3+1] = Math.random()*30+10; snowPos[i*3+2] = (Math.random()-0.5)*50;
            snowVel.push(0.05 + Math.random()*0.1);
        }
        snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos,3));
        const snow = new THREE.Points(snowGeo, new THREE.PointsMaterial({color:0xffffff, size:0.2, transparent:true, opacity:0.8}));
        scene.add(snow);

        const modal = document.getElementById('modal');
        const wisherName = document.getElementById('wisher-name');
        const sttDisplay = document.getElementById('stt-display');
        const wishContentArea = document.getElementById('wish-content-area');
        const closeBtn = document.querySelector('.close-btn');
        const openAllBtn = document.getElementById('open-all-btn');
        const slideshowBtn = document.getElementById('slideshow-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        
        let slideshowInterval;
        let isSlideshowActive = false;

        function showGiftContent(object) {
            const boxId = object.userData.id;
            const mappedIndex = giftMapping[boxId]; 
            let wishHTML = "";
            if (mappedIndex === 40) {
                wisherName.innerText = "C√¥ Tr·∫ßn Th·ªã Nh∆∞"; sttDisplay.innerText = "Gi√°o Vi√™n Ch·ªß Nhi·ªám";
                wishHTML = `<p class="single-wish">Ch√∫c C√¥ Nh∆∞ m·ªôt m√πa gi√°ng sinh vui v·∫ª m√£i l√† s·∫øp c·ªßa A4 !</p>`;
            } else {
                const studentIndex = mappedIndex;
                if (studentIndex >= 0 && studentIndex < classList.length) {
                    wisherName.innerText = classList[studentIndex];
                    sttDisplay.innerText = `Th√†nh vi√™n s·ªë #${studentIndex + 1}`; 
                    wishHTML = `<p class="single-wish">${specificWishes[studentIndex]}</p>`;
                }
            }
            wishContentArea.innerHTML = wishHTML;
        }

        let isIntroPlayed = false;
        let introGroup = new THREE.Group(); 
        scene.add(introGroup);
        let introGift = null;
        let drawingTree = null; 

        function createIntroGift() {
            const size = 3;
            const geometry = new THREE.BoxGeometry(size, size, size);
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ff0000'; ctx.fillRect(0,0,512,512);
            ctx.fillStyle = '#ffd700'; ctx.fillRect(200,0,112,512); ctx.fillRect(0,200,512,112); // Ribbon
            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.MeshStandardMaterial({ map: tex });
            introGift = new THREE.Mesh(geometry, mat);
            introGift.position.set(0, -5, 10); 
            introGift.castShadow = true;
            introGroup.add(introGift);
        }
        createIntroGift();

        function createDrawingTree() {
            const particleCount = 1500;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            
            for(let i=0; i<particleCount; i++) {
                const t = i / particleCount;
                const angle = t * Math.PI * 20; 
                const radius = 5 * (1 - t);
                const height = t * 10; 

                positions[i*3] = Math.cos(angle) * radius;
                positions[i*3+1] = height;
                positions[i*3+2] = Math.sin(angle) * radius;

                const c = new THREE.Color();
                c.setHSL(t * 0.3, 1.0, 0.5); 
                colors[i*3] = c.r; colors[i*3+1] = c.g; colors[i*3+2] = c.b;
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            geometry.setDrawRange(0, 0);

            const material = new THREE.PointsMaterial({
                size: 0.2, vertexColors: true, blending: THREE.AdditiveBlending, depthWrite: false, transparent: true, opacity: 0.8
            });

            drawingTree = new THREE.Points(geometry, material);
            drawingTree.position.set(0, 0, 10);
            introGroup.add(drawingTree);
            return { mesh: drawingTree, geometry: geometry, count: particleCount };
        }

        slideshowBtn.addEventListener('click', () => {
            if (modal.style.display === 'flex') return;
            if (isSlideshowActive) return; 

            isSlideshowActive = true;
            
            if (!isIntroPlayed) {
                playIntroSequence();
            } else {
                playLoop();
            }
        });

        function playIntroSequence() {
            gsap.to(camera.position, { x: 0, y: 5, z: 25, duration: 1.5 });
            
            introGift.position.y = -5;
            introGift.scale.set(1,1,1);
            introGift.visible = true;
            gsap.to(introGift.position, { y: 1.5, duration: 1, ease: "back.out(1.2)", onComplete: () => {
                
                gsap.to(introGift.scale, { x: 2, y: 2, z: 2, duration: 0.5, opacity: 0 });
                gsap.to(introGift.rotation, { y: Math.PI, duration: 0.5 });
                setTimeout(() => { introGift.visible = false; }, 500);

                const treeObj = createDrawingTree();
                const drawState = { val: 0 };
                
                gsap.to(drawState, { val: treeObj.count, duration: 4, ease: "linear", onUpdate: () => {
                    treeObj.geometry.setDrawRange(0, Math.floor(drawState.val));
                }, onComplete: () => {
                    const sGeo = new THREE.IcosahedronGeometry(0.8, 0);
                    const sMat = new THREE.MeshBasicMaterial({color: 0xffff00});
                    const bigStar = new THREE.Mesh(sGeo, sMat);
                    bigStar.position.set(0, 10, 0); 
                    drawingTree.add(bigStar);
                    
                    gsap.to(drawingTree.rotation, { y: Math.PI*2, duration: 3, repeat: -1, ease: "linear" });

                    setTimeout(() => {
                        gsap.to(introGroup.position, { y: 10, opacity: 0, duration: 1, onComplete: () => {
                            introGroup.visible = false;
                            isIntroPlayed = true; 
                            
                            gsap.to(camera.position, { x: 0, y: 5, z: 15, duration: 1.5 });
                            
                            playLoop();
                        }});
                    }, 2000);
                }});
            }});
        }

        let loopIndex = 0;
        function playLoop() {
            if (!isSlideshowActive) return;
            if (loopIndex >= totalGifts) { isSlideshowActive = false; return; }

            let targetIndex = loopIndex; 
            
            if (!isShuffled) {
                if (loopIndex === 0) {
                    targetIndex = 40; 
                } else {
                    targetIndex = loopIndex - 1; 
                }
            }

            const object = giftMeshes[targetIndex];
            const originalY = object.position.y;
            
            gsap.to(object.position, { y: originalY + 2, duration: 0.5, yoyo: true, repeat: 1 });
            gsap.to(object.rotation, { y: object.rotation.y + Math.PI, duration: 0.5 });
            
            showGiftContent(object);
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);

            slideshowInterval = setTimeout(() => {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none';
                    loopIndex++;
                    if(isSlideshowActive) playLoop();
                }, 300);
            }, 10000); 
        }

        const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();
        window.addEventListener('click', (event) => {
            if (modal.style.display === 'flex' || welcomeModal.style.display !== 'none' || event.target.tagName === 'BUTTON') return;
            mouse.x = (event.clientX / window.innerWidth)*2-1; mouse.y = -(event.clientY / window.innerHeight)*2+1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(giftMeshes);
            if (intersects.length > 0) {
                const object = intersects[0].object;
                if (object.userData.isGift) {
                    gsap.to(object.position, {y: object.position.y+1, duration: 0.3, yoyo:true, repeat:1});
                    showGiftContent(object);
                    setTimeout(()=>{modal.style.display='flex'; setTimeout(()=>modal.classList.add('active'),10);}, 300);
                }
            }
        });

        shuffleBtn.addEventListener('click', () => {
            isShuffled = !isShuffled; 
            if (isShuffled) {
                shuffleBtn.innerText = "üîÑ V·ªÅ M·∫∑c ƒê·ªãnh"; shuffleBtn.style.background = "linear-gradient(45deg, #e67e22, #f39c12)";
                for (let i=giftMapping.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [giftMapping[i],giftMapping[j]]=[giftMapping[j],giftMapping[i]]; }
                giftMeshes.forEach((g,i) => { gsap.to(g.rotation, {y:g.rotation.y+Math.PI, duration:0.5, delay:i*0.02}); });
            } else {
                shuffleBtn.innerText = "üîÄ Tr√°o ƒê·ªïi"; shuffleBtn.style.background = "linear-gradient(45deg, #8e44ad, #9b59b6)";
                giftMapping = Array.from({length:41},(_,i)=>i);
                giftMeshes.forEach((g,i) => { gsap.to(g.rotation, {y:g.rotation.y-Math.PI, duration:0.5, delay:i*0.02}); });
            }
        });

        openAllBtn.addEventListener('click', () => {
            if (modal.style.display === 'flex') return; isSlideshowActive = false; 
            giftMeshes.forEach((g,i) => {
                gsap.to(g.position, {y:g.position.y+2, duration:0.5, yoyo:true, repeat:1, delay:i*0.05});
                gsap.to(g.rotation, {y:g.rotation.y+Math.PI*2, duration:0.5, delay:i*0.05});
            });
            wisherName.innerText = "DANH S√ÅCH L·ªúI CH√öC 11A4"; sttDisplay.innerText = "Ch√∫c M·ª´ng Gi√°ng Sinh & NƒÉm M·ªõi";
            let h = `<div class="list-item" style="background:#fff0f5;padding:10px;"><div class="list-name">üëë C√¥ Tr·∫ßn Th·ªã Nh∆∞ (GVCN)</div><div class="list-wish">Ch√∫c C√¥ Nh∆∞ m·ªôt m√πa gi√°ng sinh vui v·∫ª m√£i l√† s·∫øp c·ªßa A4 !</div></div>`;
            classList.forEach((n,i) => { h += `<div class="list-item"><div class="list-name">#${i+1}. ${n}</div><div class="list-wish">${specificWishes[i]}</div></div>`; });
            wishContentArea.innerHTML = h;
            setTimeout(()=>{modal.style.display='flex';setTimeout(()=>modal.classList.add('active'),10);}, 1500);
        });

        closeBtn.onclick = () => {
            isSlideshowActive = false; clearTimeout(slideshowInterval);
            modal.classList.remove('active'); setTimeout(()=>modal.style.display='none', 300);
        };

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            controls.update();
            treeGroup.rotation.y = time * 0.1;
            lightsGroup.children.forEach(child => {
                if (child.isMesh) child.material.color.lerpColors(child.userData.baseColor, new THREE.Color(0xffffff), (Math.sin(time * child.userData.speed + child.userData.phase)+1)/2 * 0.5);
            });
            const pos = snow.geometry.attributes.position.array;
            for(let i=0; i<snowCount; i++) {
                pos[i*3+1] -= snowVel[i];
                if(pos[i*3+1]<0) pos[i*3+1] = 30 + Math.random()*10;
            }
            snow.geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        animate();
    </script>
</body>

</html>

